<% content_for :title, @product.name %>
<% content_for :native_signals, native_form_tag %>

<%
  size_adjustments = Product::SIZE_ADJUSTMENTS
  extras = [["Vanilla syrup", 70], ["Caramel drizzle", 70], ["Extra shot", 80], ["Whipped cream", 50]]
%>

<div class="mt-4"
  data-controller="price"
  data-price-base-value="<%= @product.base_price %>"
  data-price-small-adj-value="<%= size_adjustments["small"] %>"
  data-price-large-adj-value="<%= size_adjustments["large"] %>">

  <% if @product.image_url.present? %>
    <%= image_tag @product.image_url, class: "w-full aspect-square rounded-2xl object-cover", alt: @product.name %>
  <% else %>
    <div class="w-full aspect-square rounded-2xl bg-coffee-200 dark:bg-coffee-800"></div>
  <% end %>

  <div class="mt-4">
    <h1 class="text-2xl font-bold text-coffee-800 dark:text-coffee-100 <%= "hidden" if native_app? %>">
      <%= @product.name %>
    </h1>
    <p class="text-sm text-coffee-500 dark:text-coffee-400 mt-1"><%= @product.description %></p>
    <p class="text-lg font-bold text-green-700 dark:text-green-400 mt-2" data-price-target="price"><%= @product.display_price %></p>
  </div>

  <%= form_with url: cart_cart_items_path, class: "mt-6 space-y-6" do |form| %>
    <%= form.hidden_field :product_id, value: @product.id %>

    <div>
      <h3 class="text-sm font-semibold text-coffee-700 dark:text-coffee-300 mb-2">Size</h3>
      <div class="flex gap-2">
        <% %w[small medium large].each_with_index do |size, i| %>
          <label class="flex-1">
            <input type="radio" name="size" value="<%= size %>" class="peer hidden" <%= "checked" if i == 1 %>
              data-action="price#update">
            <div class="text-center py-2 px-3 rounded-xl border-2 border-coffee-200 dark:border-coffee-700 text-sm font-medium text-coffee-700 dark:text-coffee-300 cursor-pointer peer-checked:border-coffee-800 peer-checked:bg-coffee-800 peer-checked:text-white dark:peer-checked:border-coffee-200 dark:peer-checked:bg-coffee-200 dark:peer-checked:text-coffee-900 transition">
              <%= size.capitalize %>
              <span class="block text-xs opacity-70">$<%= "%.2f" % (@product.price_for_size(size) / 100.0) %></span>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <% unless @product.category.name == "Pastries" %>
      <div>
        <h3 class="text-sm font-semibold text-coffee-700 dark:text-coffee-300 mb-2">Milk</h3>
        <div class="flex flex-wrap gap-2">
          <% %w[Whole Oat Almond Soy].each_with_index do |milk, i| %>
            <label>
              <input type="radio" name="milk" value="<%= milk %>" class="peer hidden" <%= "checked" if i == 0 %>>
              <div class="py-2 px-4 rounded-xl border-2 border-coffee-200 dark:border-coffee-700 text-sm font-medium text-coffee-700 dark:text-coffee-300 cursor-pointer peer-checked:border-coffee-800 peer-checked:bg-coffee-800 peer-checked:text-white dark:peer-checked:border-coffee-200 dark:peer-checked:bg-coffee-200 dark:peer-checked:text-coffee-900 transition">
                <%= milk %>
              </div>
            </label>
          <% end %>
        </div>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-coffee-700 dark:text-coffee-300 mb-2">Extras</h3>
        <div class="space-y-2">
          <% extras.each do |name, price| %>
            <label class="group flex items-center justify-between p-3 rounded-xl border-2 border-coffee-200 dark:border-coffee-700 cursor-pointer has-[:checked]:border-coffee-800 has-[:checked]:bg-coffee-50 dark:has-[:checked]:border-coffee-200 dark:has-[:checked]:bg-coffee-900 transition">
              <div class="flex items-center gap-3">
                <input type="checkbox" name="extras[]" value="<%= name %>" data-price="<%= price %>"
                  data-action="price#update"
                  class="sr-only">
                <div class="w-5 h-5 rounded-md border-2 border-coffee-300 dark:border-coffee-600 group-has-[:checked]:bg-coffee-800 group-has-[:checked]:border-coffee-800 dark:group-has-[:checked]:bg-coffee-200 dark:group-has-[:checked]:border-coffee-200 flex items-center justify-center shrink-0 transition">
                  <svg class="w-3 h-3 text-white dark:text-coffee-900 opacity-0 group-has-[:checked]:opacity-100 transition" viewBox="0 0 12 10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L4.5 9L11 1"/></svg>
                </div>
                <span class="text-sm font-medium text-coffee-700 dark:text-coffee-300"><%= name %></span>
              </div>
              <span class="text-sm text-coffee-500 dark:text-coffee-400">+$<%= "%.2f" % (price / 100.0) %></span>
            </label>
          <% end %>
        </div>
      </div>
    <% end %>

    <div>
      <%= form.submit "Add to order Â· #{@product.display_price}",
        data: { price_target: "submit" },
        class: "w-full rounded-xl bg-coffee-800 dark:bg-coffee-200 text-white dark:text-coffee-900 font-semibold py-3 hover:bg-coffee-700 dark:hover:bg-coffee-300 transition cursor-pointer" %>
    </div>
  <% end %>
</div>
